
# Read data
################################################################################

# Clear workspace
rm(list = ls())

# Packages
library(zoo) # rollmean
library(plyr)
library(dplyr)
library(RColorBrewer)

# Spatial packages
library(sp) # spTransform()
library(rgdal) # readOGR()
library(rgeos) # gCentroid(), gArea()
library(mapproj)

# Directories
datadir <- "data/fao_landings/data"
preddir <- "data/fao_landings/predictions"
plotdir <- "data/fao_landings/figures"


# Read data
load(paste(datadir, "1950_2017_FAO_landings_data_use.Rdata", sep="/"))
catch <- data; rm(data)
centroids <- read.csv(paste(datadir, "FAO_ISO3_stock_centroids.csv", sep="/"), as.is=T)
bbmsy <- read.csv(paste(preddir, "1950_2017_FAO_bbmsy_timeseries_merge.csv", sep="/"), as.is=T)


# Build data
################################################################################

# Calculate rolling average
bbmsy <- bbmsy %>%
  group_by(stockid) %>% 
  mutate(super_5yr=rollmean(super, 5, align="left", fill=NA),
         super_10yr=rollmean(super, 10, align="left", fill=NA))

# Identify years of first development, overexploitation, and collapse
data <- bbmsy %>% 
  group_by(stockid, areaid) %>% 
  summarize(yr_full = min(year[super_10yr<1 & !is.na(super_10yr)]),
            yr_over = min(year[super_5yr<0.5 & !is.na(super_5yr)]), 
            yr_collapse= min(year[super_5yr<0.2 & !is.na(super_5yr)])) %>% 
  # Change "infinite" years to NA years
  mutate(yr_full=ifelse(is.infinite(yr_full), NA, yr_full),
         yr_over=ifelse(is.infinite(yr_over), NA, yr_over),
         yr_collapse=ifelse(is.infinite(yr_collapse), NA, yr_collapse)) %>% 
  # Add stock information
  left_join(stocks, by="stockid") %>% 
  # Add MFA centroids
  left_join(select(centroids, areaid, long_dd, lat_dd), by="areaid") %>% 
  select(stockid, areaid, fao_code:lat_dd,
         yr_full, yr_over, yr_collapse, everything())
  
# Export data
write.csv(data, paste(datadir, "FAO_stocks_full_over_collapse_years.csv", sep="/"), row.names=F)


# Visualize data
################################################################################

# Species sample size
nspp <- data %>% 
  group_by(sci_name_fb, comm_name) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n)) %>% 
  filter(n>=10)

# Color palette
color_pal <- brewer.pal(9,"YlOrRd")[3:9]

# Plot data
figname <- "AppendixC_sequential_exploitation.pdf"
pdf(paste(plotdir, figname, sep="/"), width=8.5, height=11)
par(mfrow=c(2,1))

# Loop through species: i <- 1
# for(i in 1){
for(i in 1:nrow(nspp)){
  
  # Subset data
  spp <- nspp$sci_name_fb[i]
  comm_name <- nspp$comm_name[i]
  sdata <- subset(data, sci_name_fb==spp)
  print(paste(i, comm_name))
  
  # Color by year of first development
  nyr <- length(min(sdata$yr_full, na.rm=T):max(sdata$yr_full, na.rm=T))
  colors <- colorRampPalette(color_pal)(nyr)
  sdata$yr_full_col <- colors[sdata$yr_full-min(sdata$yr_full, na.rm=T)+1]
  sdata$yr_full_col[is.na(sdata$yr_full_col)] <- "grey30"
  
  # Color by year of first overexploitation
  if(sum(!is.na(sdata$yr_over))>0){
    nyr <- length(min(sdata$yr_over, na.rm=T):max(sdata$yr_over, na.rm=T))
    colors <- colorRampPalette(color_pal)(nyr)
    sdata$yr_over_col <- colors[sdata$yr_over-min(sdata$yr_over, na.rm=T)+1]
    sdata$yr_over_col[is.na(sdata$yr_over_col)] <- "grey30"
  }else{
    sdata$yr_over_col <- "grey30"
  }
  
  # Stats
  n <- nrow(sdata)
  n_full <- sum(!is.na(sdata$yr_full))
  n_over <- sum(!is.na(sdata$yr_over))
  
  # Year of first development
  ##############################################################################
  
  # Plot world map
  xlim <- c(-180, 180)
  ylim <- c(-90, 90)
  map("world", col="grey85", fill=T, border="white", lwd=0.3, xlim=xlim, ylim=ylim)
  title("Year of first development")
  mtext(paste(n_full, "of", n, "developed"), side=3, adj=0.5, line=0.5)
  
  # Plot "fully developed" stocks
  points(x=sdata$long_dd, y=sdata$lat_dd, pch=16, col=sdata$yr_full_col, cex=1.2)
  text(x=sdata$long_dd, y=sdata$lat_dd, col=sdata$yr_full_col, label=sdata$yr_full, pos=4, cex=0.8)
  
  # Plot stocks not yet fully developed
  not_dev <- subset(sdata, is.na(yr_full))
  if(nrow(not_dev)>0){
    text(x=not_dev$long_dd, y=not_dev$lat_dd, col="black", label="", pos=4, cex=0.8)
  }
  
  # Add species label
  title(comm_name, adj=0)
  title(spp, adj=0, line=0.8)
  
  
  # Year of first overexploitation
  ##############################################################################
  
  # Plot world map
  xlim <- c(-180, 180)
  ylim <- c(-90, 90)
  map("world", col="grey85", fill=T, border="white", lwd=0.3, xlim=xlim, ylim=ylim)
  title("Year of first overexploitation")
  mtext(paste(n_over, "of", n, "overexploited"), side=3, adj=0.5, line=0.5)
  
  # Plot stocks
  points(x=sdata$long_dd, y=sdata$lat_dd, pch=16, col=sdata$yr_over_col, cex=1.2)
  text(x=sdata$long_dd, y=sdata$lat_dd, col=sdata$yr_over_col, label=sdata$yr_over, pos=4, cex=0.8)
  
  # Plot stocks not yet overexploited
  not_dev <- subset(sdata, is.na(yr_over))
  if(nrow(not_dev)>0){
    text(x=not_dev$long_dd, y=not_dev$lat_dd, col="black", label="", pos=4, cex=0.8)
  }
  
}

# Off
dev.off()
graphics.off()




